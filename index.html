<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ—¥ç³»æ¥µç°¡è‡ªå¾‹æ‰“å¡ App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="https://unpkg.com/lucide@0.258.0/dist/lucide.esm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    /* å…¨å±€ç¡¬é‚Šæ¡† & åœ“è§’ & ç¡¬é™°å½± */
    .card { border: 2px solid #065f46; border-radius: 1.5rem; box-shadow: 6px 6px 0px 0px #065f46; background:white; }
    .status-circle { width:40px;height:40px;border-radius:9999px;display:flex;align-items:center;justify-content:center; }
    .fixed-nav { position:fixed;bottom:32px;left:50%;transform:translateX(-50%);width:90%;display:flex;justify-content:space-between;background:white; border:2px solid #065f46; border-radius:1.5rem; box-shadow:6px 6px 0 #065f46; padding:0.5rem 1rem; }
    .btn { border:2px solid #065f46; border-radius:1.5rem; box-shadow:6px 6px 0 #065f46; padding:0.5rem 1rem; text-align:center; font-weight:900; cursor:pointer; }
    .btn:active { transform:translateY(2px); box-shadow:2px 2px 0 #065f46; }
  </style>
</head>
<body class="bg-white font-sans">
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD9KAWLvPjTOIoImxobugT6dQUbQmJiCGg",
      authDomain: "actiongame-7c8c9.firebaseapp.com",
      projectId: "actiongame-7c8c9",
      storageBucket: "actiongame-7c8c9.appspot.com",
      messagingSenderId: "386021872588",
      appId: "1:386021872588:web:eb6019fa0a182d3aec4369",
      measurementId: "G-W6CNY1D4RL"
    };
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth();
    const db = getDatabase(app);

    let currentUser = null;
    let usersData = {};

    // ç™»å…¥
    async function login() {
      const provider = new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      currentUser = result.user;
      if (!usersData[currentUser.uid]) {
        await set(ref(db, 'users/' + currentUser.uid), { name: currentUser.displayName, weeklyTotal:0, projects:{} });
      }
      showDashboard();
    }

    function logout() {
      signOut(auth);
    }

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) {
        loadUsersData();
      } else {
        document.getElementById('app').innerHTML = `<div class="flex flex-col items-center justify-center h-screen gap-4">
          <h1 class="text-3xl font-black text-[#065f46]">æ—¥ç³»æ¥µç°¡è‡ªå¾‹æ‰“å¡</h1>
          <button class="btn bg-[#beff64]" onclick="login()">Google ç™»å…¥</button>
        </div>`;
      }
    });

    function loadUsersData() {
      const usersRef = ref(db, 'users');
      onValue(usersRef, (snapshot) => {
        usersData = snapshot.val() || {};
        showDashboard();
      });
    }

    // ===================== Dashboard =====================
    function showDashboard() {
      const projects = ['ç·´åŠŸ','äº”åˆ†é˜','é‹å‹•','æ‹‰ç­‹'];
      const weekDays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
      const userData = usersData[currentUser.uid] || { weeklyTotal:0, projects:{} };
      const todayIndex = new Date().getDay();

      document.getElementById('app').innerHTML = `
        <div class="flex flex-col gap-4 p-4">
          <!-- Header -->
          <div class="flex justify-between items-center">
            <h2 class="text-xl font-black text-[#065f46]">Dashboard</h2>
            <div class="card w-12 h-12 flex items-center justify-center cursor-pointer" onclick="showProfile()">
              ${currentUser.displayName[0]}
            </div>
          </div>

          <!-- é€±ç´¯è¨ˆ -->
          <div class="card p-4 flex justify-between items-center text-2xl font-black text-[#FACC15]">
            <span>æœ¬é€±ç´¯è¨ˆ</span>
            <span id="weeklyTotal">${userData.weeklyTotal || 0} min</span>
          </div>

          <!-- å°ˆæ¡ˆç‹€æ…‹ -->
          ${projects.map(p=>{
            const statusArr = userData.projects[p] || Array(7).fill(false);
            return `<div class="card p-4 flex flex-col gap-2">
              <div class="flex justify-between font-black text-[#065f46]">${p} <span>${statusArr.filter(s=>s).length} æ¬¡</span></div>
              <div class="flex gap-2">
                ${statusArr.map((s,i)=>`<div class="status-circle ${s?'bg-[#FACC15]':'bg-gray-200'}">${s?'ğŸ˜„':''}</div>`).join('')}
              </div>
            </div>`;
          }).join('')}

          <!-- æ‰“å¡æŒ‰éˆ• -->
          <button class="btn w-full bg-[#beff64] text-xl mt-2" onclick="openLogModal()">+ æ‰“å¡</button>
        </div>

        <!-- Log Modal -->
        <div id="logModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden">
          <div class="card p-4 flex flex-col gap-4 w-3/4">
            <h3 class="text-xl font-black text-[#065f46]">é¸æ“‡å°ˆæ¡ˆæ‰“å¡</h3>
            ${projects.map(p=>`<button class="btn bg-white" onclick="logProject('${p}')">${p}</button>`).join('')}
            <button class="btn bg-gray-200" onclick="closeLogModal()">å–æ¶ˆ</button>
          </div>
        </div>

        <!-- Fixed Nav -->
        <div class="fixed-nav">
          <div onclick="showDashboard()" class="flex flex-col items-center"><i data-lucide="home"></i><span class="text-xs">é¦–é </span></div>
          <div onclick="showCalendar()" class="flex flex-col items-center"><i data-lucide="calendar"></i><span class="text-xs">æ—¥æ›†</span></div>
          <div onclick="showRanking()" class="flex flex-col items-center"><i data-lucide="award"></i><span class="text-xs">æ’è¡Œæ¦œ</span></div>
          <div onclick="showProfile()" class="flex flex-col items-center"><i data-lucide="user"></i><span class="text-xs">å€‹äºº</span></div>
        </div>
      `;
      lucide.createIcons();
    }

    // ===================== Log Modal =====================
    function openLogModal() { document.getElementById('logModal').classList.remove('hidden'); }
    function closeLogModal() { document.getElementById('logModal').classList.add('hidden'); }

    function logProject(projectName) {
      const userRef = ref(db, 'users/' + currentUser.uid);
      const todayIndex = new Date().getDay();
      const userData = usersData[currentUser.uid] || { projects:{} };
      if(!userData.projects[projectName]) userData.projects[projectName]=Array(7).fill(false);
      userData.projects[projectName][todayIndex] = true;
      userData.weeklyTotal = (userData.weeklyTotal || 0) + 5;
      update(userRef, userData);
      closeLogModal();
      confetti({ particleCount: 100, colors: ['#beff64','#FACC15'] });
    }

    // ===================== Placeholder: Calendar / Ranking / Profile =====================
    function showCalendar(){ alert('Calendar æ¨¡çµ„å¾…æ•´åˆ'); }
    function showRanking(){ alert('Ranking æ¨¡çµ„å¾…æ•´åˆ'); }
    function showProfile(){ alert('Profile æ¨¡çµ„å¾…æ•´åˆ'); }
  </script>

  <div id="app" class="h-screen"></div>
</body>
</html>
