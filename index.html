<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>自律動起來</title>
    <script>
        (function() {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) return;
                originalWarn.apply(console, args);
            };
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0",
            "canvas-confetti": "https://esm.sh/canvas-confetti@1.9.2",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"
        }
    }
    </script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>
    <script type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Trophy, User, Plus, LayoutGrid, Check, Zap } from 'lucide-react';
        import confetti from 'canvas-confetti';
        import { initializeApp } from "firebase/app";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from "firebase/firestore";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "firebase/auth";

        const firebaseConfig = {
            apiKey: "AIzaSyD9KAWLvPjTOIoImxobugT6dQUbQmJiCGg",
            authDomain: "actiongame-7c8c9.firebaseapp.com",
            projectId: "actiongame-7c8c9",
            storageBucket: "actiongame-7c8c9.firebasestorage.app",
            messagingSenderId: "386021872588",
            appId: "1:386021872588:web:eb6019fa0a182d3aec4369"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [showModal, setShowModal] = useState(false);
            const [allUsers, setAllUsers] = useState([]);

            useEffect(() => {
                onAuthStateChanged(auth, (u) => setUser(u));
                return onSnapshot(collection(db, 'rankings'), (snap) => {
                    const list = [];
                    snap.forEach(d => list.push({ id: d.id, ...d.data() }));
                    setAllUsers(list.sort((a,b) => b.score - a.score));
                });
            }, []);

            const login = async () => {
                const res = await signInWithPopup(auth, new GoogleAuthProvider());
                await setDoc(doc(db, 'rankings', res.user.uid), { 
                    name: res.user.displayName, score: 0 
                }, { merge: true });
            };

            const submit = async () => {
                const ref = doc(db, 'rankings', user.uid);
                const snap = await getDoc(ref);
                const newScore = (snap.exists() ? snap.data().score : 0) + 10;
                await setDoc(ref, { score: newScore }, { merge: true });
                confetti();
                setShowModal(false);
            };

            return (
                <div className="max-w-md mx-auto min-h-screen flex flex-col">
                    <header className="p-6 border-b flex justify-between items-center bg-white">
                        <h1 className="text-xl font-bold text-emerald-800">自律動起來</h1>
                        {user ? <img src={user.photoURL} className="w-8 h-8 rounded-full border border-emerald-800" /> : <button onClick={login} className="text-sm font-bold border px-3 py-1 rounded-lg">登入</button>}
                    </header>

                    <main className="p-6 flex-1">
                        {activeTab === 'dashboard' ? (
                            <div className="space-y-6">
                                <button onClick={() => setShowModal(true)} className="w-full bg-[#beff64] border-2 border-emerald-900 p-8 rounded-3xl font-black text-xl shadow-[4px_4px_0_0_#065f46]">
                                    點我打卡 +10
                                </button>
                                <div className="space-y-3">
                                    <h2 className="font-bold">排行榜</h2>
                                    {allUsers.map((u, i) => (
                                        <div key={u.id} className="flex justify-between p-4 bg-white border rounded-xl">
                                            <span>#{i+1} {u.name}</span>
                                            <span className="font-bold">{u.score} pt</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="text-center p-10">個人檔案開發中...</div>
                        )}
                    </main>

                    <nav className="fixed bottom-6 left-6 right-6 bg-emerald-900 text-white rounded-2xl p-4 flex justify-around">
                        <button onClick={() => setActiveTab('dashboard')}><LayoutGrid /></button>
                        <button onClick={() => setActiveTab('profile')}><User /></button>
                    </nav>

                    {showModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-6">
                            <div className="bg-white p-6 rounded-2xl w-full max-w-xs">
                                <h3 className="font-bold text-lg mb-4">確認打卡？</h3>
                                <button onClick={submit} className="w-full bg-emerald-900 text-white py-3 rounded-xl font-bold">送出</button>
                                <button onClick={() => setShowModal(false)} className="w-full mt-2 text-gray-400">取消</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
