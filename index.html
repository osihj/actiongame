<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ—¥ç³»æ¥µç°¡è‡ªå¾‹æ‰“å¡ App</title>
  <script type="module">
    // Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyD9KAWLvPjTOIoImxobugT6dQUbQmJiCGg",
      authDomain: "actiongame-7c8c9.firebaseapp.com",
      projectId: "actiongame-7c8c9",
      storageBucket: "actiongame-7c8c9.appspot.com",
      messagingSenderId: "386021872588",
      appId: "1:386021872588:web:eb6019fa0a182d3aec4369",
      measurementId: "G-W6CNY1D4RL"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    
    let currentUser = null;
    
    async function login() {
      await signInWithPopup(auth, provider);
    }
    
    async function logout() {
      await signOut(auth);
    }
    
    async function checkIn() {
      if (!currentUser) return;
      const userRef = doc(db, "users", currentUser.uid);
      const docSnap = await getDoc(userRef);
      let count = 0;
      if (docSnap.exists()) {
        count = docSnap.data().checkinCount || 0;
        count += 1;
        await updateDoc(userRef, { checkinCount: count });
      } else {
        await setDoc(userRef, { name: currentUser.displayName, checkinCount: 1 });
        count = 1;
      }
      document.getElementById("weekCount").innerText = count;
      triggerConfetti();
      updateLeaderboard();
      updateCalendar();
    }
    
    async function updateLeaderboard() {
      const q = query(collection(db, "users"), orderBy("checkinCount", "desc"));
      const querySnapshot = await getDocs(q);
      const leaderboard = document.getElementById("leaderboard");
      leaderboard.innerHTML = "";
      let rank = 1;
      querySnapshot.forEach(docSnap => {
        const data = docSnap.data();
        const li = document.createElement("li");
        li.className = "flex items-center justify-between p-2 border-b border-[#065f46]";
        li.innerHTML = `<span>#${rank}</span>
                        <span>${data.name}</span>
                        <span>${data.checkinCount}</span>`;
        leaderboard.appendChild(li);
        rank++;
      });
    }
    
    function updateCalendar() {
      const cal = document.getElementById("calendar");
      cal.innerHTML = "";
      const days = 7; // é€±è¦–åœ–
      for (let i=0;i<days;i++) {
        const dayDiv = document.createElement("div");
        dayDiv.className = "w-10 h-10 flex items-center justify-center border border-[#065f46] rounded-3xl";
        dayDiv.innerText = "ğŸ˜ƒ"; // ç°¡å–®ç”¨ç¬‘è‡‰è¡¨ç¤ºå·²æ‰“å¡
        cal.appendChild(dayDiv);
      }
    }
    
    function triggerConfetti() {
      const script = document.createElement("script");
      script.src = "https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js";
      script.onload = () => {
        confetti({
          particleCount: 100,
          spread: 70,
          origin: { y: 0.6 },
          colors: ['#beff64', '#FACC15']
        });
      };
      document.body.appendChild(script);
    }
    
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) {
        document.getElementById("loginBtn").style.display = "none";
        document.getElementById("logoutBtn").style.display = "block";
        document.getElementById("userName").innerText = user.displayName;
        updateLeaderboard();
        updateCalendar();
      } else {
        document.getElementById("loginBtn").style.display = "block";
        document.getElementById("logoutBtn").style.display = "none";
        document.getElementById("userName").innerText = "";
      }
    });
    
    window.login = login;
    window.logout = logout;
    window.checkIn = checkIn;
  </script>
  <style>
    body { font-family: sans-serif; background: #F9FAFB; color: #065f46; margin:0; padding:0; }
    .btn { padding: 1rem 2rem; border-radius: 2rem; border: 2px solid #065f46; background: #beff64; cursor:pointer; font-weight:bold; box-shadow: 6px 6px #065f46; transition: transform 0.1s; }
    .btn:active { transform: translateY(2px); }
    nav { position: fixed; bottom:0; left:50%; transform: translateX(-50%); width:95%; display:flex; justify-around; padding:0.5rem; background:#FFFFFF; border-radius:2rem; box-shadow:0 6px #065f46; }
    .card { background:#FFFFFF; border:2px solid #065f46; border-radius:2rem; padding:1rem; margin:1rem; box-shadow:6px 6px #065f46; }
    #calendar { display:flex; gap:4px; margin:1rem 0; }
    #leaderboard { list-style:none; padding:0; margin:0; }
    #leaderboard li { display:flex; justify-content:space-between; }
  </style>
</head>
<body>
  <header class="card">
    <span id="userName"></span>
    <button id="loginBtn" class="btn" onclick="login()">Google ç™»å…¥</button>
    <button id="logoutBtn" class="btn" onclick="logout()" style="display:none;">ç™»å‡º</button>
  </header>

  <main class="card">
    <h2>æœ¬é€±ç´¯è¨ˆåˆ†é˜æ•¸</h2>
    <div id="weekCount" class="text-3xl font-black text-[#FACC15]">0</div>
    <button class="btn mt-4" onclick="checkIn()">ï¼‹ æ‰“å¡</button>
  </main>

  <section class="card">
    <h2>æ—¥æ›† (é€±è¦–åœ–)</h2>
    <div id="calendar"></div>
  </section>

  <section class="card">
    <h2>æ’è¡Œæ¦œ</h2>
    <ol id="leaderboard"></ol>
  </section>

  <nav>
    <button>é¦–é </button>
    <button>æ—¥æ›†</button>
    <button>æ’è¡Œæ¦œ</button>
    <button>å€‹äºº</button>
  </nav>
</body>
</html>
