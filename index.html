<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>自律動起來</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            green: '#beff64',
                            yellow: '#FACC15',
                            teal: '#065f46', // 日系藍綠色
                        }
                    },
                    fontFamily: {
                        sans: ['system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0",
            "canvas-confetti": "https://esm.sh/canvas-confetti@1.9.2",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/analytics": "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js"
        }
    }
    </script>
    
    <style>
        /* 自定義動畫與細節樣式 */
        body { background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Calendar, Trophy, User, Plus, ChevronLeft, ChevronRight,
            Clock, Flame, XCircle, LayoutGrid, Rows, LogIn, Mail,
            Target, Dumbbell, Smile, Zap, LogOut, Award, BarChart3,
            Medal, Check
        } from 'lucide-react';
        import confetti from 'canvas-confetti';

        // Firebase 模組導入
        import { initializeApp } from "firebase/app";
        import { getAnalytics } from "firebase/analytics";
        import { 
            getFirestore, collection, doc, setDoc, getDoc,
            onSnapshot, serverTimestamp 
        } from "firebase/firestore";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithCustomToken, 
            signOut,
            GoogleAuthProvider,
            signInWithPopup,
            signInAnonymously
        } from "firebase/auth";

        // --- 你的 Firebase 設定 (已整合) ---
        const firebaseConfig = {
            apiKey: "AIzaSyD9KAWLvPjTOIoImxobugT6dQUbQmJiCGg",
            authDomain: "actiongame-7c8c9.firebaseapp.com",
            projectId: "actiongame-7c8c9",
            storageBucket: "actiongame-7c8c9.firebasestorage.app",
            messagingSenderId: "386021872588",
            appId: "1:386021872588:web:eb6019fa0a182d3aec4369",
            measurementId: "G-W6CNY1D4RL"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app); // 初始化分析功能
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // 這是我們資料庫內部的專案識別碼，保持不變
        const appId = 'self-discipline-app';

        // 顏色定義
        const BRAND_GREEN = "#beff64";
        const NIPPON_YELLOW = "#FACC15";
        const JAPAN_TEAL = "#065f46";   

        // 生成時間選項
        const generateTimeOptions = (min, max) => {
            const options = [];
            for (let i = min; i <= max; i += 5) {
                options.push(i);
            }
            return options;
        };

        // 元件：排名篩選按鈕
        const RankingFilterBtn = ({ active, onClick, label }) => (
            <button 
                onClick={onClick}
                className={`px-4 py-2 rounded-full font-black text-xs transition-all border-2 ${
                    active ? 'bg-emerald-900 text-white' : 'bg-white text-[#065f46]'
                }`}
                style={{ 
                    borderColor: JAPAN_TEAL,
                    backgroundColor: active ? JAPAN_TEAL : 'white',
                    color: active ? 'white' : JAPAN_TEAL
                }}
            >
                {label}
            </button>
        );

        // 元件：個人資料統計卡片
        const ProfileStatCard = ({ icon, label, value, unit, highlight = false }) => (
            <div className={`rounded-2xl p-4 border-2 flex items-center justify-between ${highlight ? 'bg-[#beff64]/20' : 'bg-white'}`}
                 style={{ borderColor: JAPAN_TEAL, boxShadow: `4px 4px 0px 0px ${JAPAN_TEAL}` }}>
                <div className="flex items-center space-x-3">
                    <div className="p-2 bg-white rounded-lg border-2" style={{ borderColor: JAPAN_TEAL }}>
                        {icon}
                    </div>
                    <span className="font-bold text-gray-600">{label}</span>
                </div>
                <div className="flex items-baseline space-x-1">
                    <span className="text-2xl font-black" style={{ color: JAPAN_TEAL }}>{value || 0}</span>
                    <span className="text-xs font-bold opacity-50">{unit}</span>
                </div>
            </div>
        );

        // 自定義笑臉或狀態點
        const StatusIndicator = ({ size = 20, active = false, color = NIPPON_YELLOW, type = "smile" }) => {
            if (!active) return <div style={{ width: size, height: size, borderColor: '#f3f4f6' }} className="rounded-full border-2 bg-gray-50/50" />;
            
            if (type === "dot") {
                return <div style={{ width: size, height: size, backgroundColor: JAPAN_TEAL, borderColor: JAPAN_TEAL }} className="rounded-full border-2" />;
            }

            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" fill={color} stroke={JAPAN_TEAL} strokeWidth="1.8"/>
                    <circle cx="9" cy="10" r="1.2" fill={JAPAN_TEAL}/>
                    <circle cx="15" cy="10" r="1.2" fill={JAPAN_TEAL}/>
                    <path d="M8 15C8.5 16.5 10 17.5 12 17.5C14 17.5 15.5 16.5 16 15" stroke={JAPAN_TEAL} strokeWidth="1.8" strokeLinecap="round"/>
                </svg>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [allUsersInfo, setAllUsersInfo] = useState([]); 
            const [dailyLogs, setDailyLogs] = useState({});
            const [showLogModal, setShowLogModal] = useState(false);
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [calendarView, setCalendarView] = useState('month');
            const [rankingType, setRankingType] = useState('totalMins'); 

            // 打卡狀態
            const [isPracticing, setIsPracticing] = useState(false);
            const [isFiveMin, setIsFiveMin] = useState(false);
            const [isWorkout, setIsWorkout] = useState(false);
            const [isStretch, setIsStretch] = useState(false);
            const [workoutMins, setWorkoutMins] = useState(5);
            const [stretchMins, setStretchMins] = useState(5);

            const getDateKey = (date) => {
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const todayKey = useMemo(() => getDateKey(new Date()), []);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleGoogleLogin = async () => {
                const provider = new GoogleAuthProvider();
                try {
                    const result = await signInWithPopup(auth, provider);
                    const user = result.user;
                    
                    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                    await setDoc(userRef, {
                        displayName: user.displayName || `使用者 ${user.uid.slice(0, 5)}`,
                        photoURL: user.photoURL || null,
                        lastActive: serverTimestamp()
                    }, { merge: true });

                } catch (error) {
                    console.error("登入失敗", error);
                    alert("登入失敗: " + error.message);
                }
            };

            useEffect(() => {
                if (!user) return;
                const publicUsersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                const unsubscribe = onSnapshot(publicUsersRef, (snapshot) => {
                    const data = [];
                    snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
                    setAllUsersInfo(data);
                }, (error) => console.error("Users Info Error:", error));
                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                if (!user) return;
                const logsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'logs');
                const unsubscribe = onSnapshot(logsRef, (snapshot) => {
                    const logs = {};
                    snapshot.forEach(doc => { logs[doc.id] = doc.data(); });
                    setDailyLogs(logs);
                }, (error) => console.error("Logs Error:", error));
                return () => unsubscribe();
            }, [user]);

            const startOfWeekKey = useMemo(() => {
                const now = new Date();
                const diff = now.getDate() - now.getDay();
                const firstDayOfWeek = new Date(now.setDate(diff));
                firstDayOfWeek.setHours(0, 0, 0, 0);
                return getDateKey(firstDayOfWeek);
            }, []);

            const weeklyStats = useMemo(() => {
                let practiceCount = 0;
                let fiveMinCount = 0;
                let totalWorkoutMins = 0;
                let totalStretchMins = 0;
                let totalMins = 0;

                Object.keys(dailyLogs).forEach(dateKey => {
                    if (dateKey >= startOfWeekKey) {
                        const log = dailyLogs[dateKey];
                        practiceCount += (log.practiceCount || 0);
                        fiveMinCount += (log.fiveMinCount || 0);
                        totalWorkoutMins += (log.workoutMins || 0);
                        totalStretchMins += (log.stretchMins || 0);
                        totalMins += (log.workoutMins || 0) + (log.stretchMins || 0);
                    }
                });
                return { practiceCount, fiveMinCount, workoutMins: totalWorkoutMins, stretchMins: totalStretchMins, totalMins };
            }, [dailyLogs, startOfWeekKey]);

            const monthlyStats = useMemo(() => {
                const now = new Date();
                const yearMonthPrefix = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
                
                let practiceCount = 0;
                let fiveMinCount = 0;
                let workoutMinsSum = 0;
                let stretchMinsSum = 0;
                let totalMins = 0;

                Object.keys(dailyLogs).forEach(dateKey => {
                    if (dateKey.startsWith(yearMonthPrefix)) {
                        const log = dailyLogs[dateKey];
                        practiceCount += (log.practiceCount || 0);
                        fiveMinCount += (log.fiveMinCount || 0);
                        workoutMinsSum += (log.workoutMins || 0);
                        stretchMinsSum += (log.stretchMins || 0);
                        totalMins += (log.workoutMins || 0) + (log.stretchMins || 0);
                    }
                });
                return { practiceCount, fiveMinCount, workoutMins: workoutMinsSum, stretchMins: stretchMinsSum, totalMins };
            }, [dailyLogs]);

            const sortedRankings = useMemo(() => {
                return [...allUsersInfo].sort((a, b) => (b[rankingType] || 0) - (a[rankingType] || 0));
            }, [allUsersInfo, rankingType]);

            const changeDateRange = (offset) => {
                if (calendarView === 'month') {
                    setSelectedDate(prev => new Date(prev.getFullYear(), prev.getMonth() + offset, 1));
                } else {
                    setSelectedDate(prev => {
                        const newDate = new Date(prev);
                        newDate.setDate(prev.getDate() + (offset * 7));
                        return newDate;
                    });
                }
            };

            const goToToday = () => {
                setSelectedDate(new Date());
            };

            const handleLogout = async () => {
                try { await signOut(auth); setUser(null); } catch (err) { console.error("登出錯誤:", err); }
            };

            const handleSaveRecord = async () => {
                if (!user) return;
                const dateKey = todayKey;
                const logRef = doc(db, 'artifacts', appId, 'users', user.uid, 'logs', dateKey);
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);

                try {
                    const logSnap = await getDoc(logRef);
                    const existingData = logSnap.exists() ? logSnap.data() : { 
                        practiceCount: 0, 
                        fiveMinCount: 0, 
                        workoutMins: 0, 
                        stretchMins: 0,
                        isPracticing: false,
                        isFiveMin: false,
                        isWorkout: false,
                        isStretch: false
                    };

                    const addedWorkoutMins = (isWorkout ? parseInt(workoutMins) : 0);
                    const addedStretchMins = (isStretch ? parseInt(stretchMins) : 0);
                    const addedTotalMins = addedWorkoutMins + addedStretchMins;

                    const logData = {
                        isPracticing: existingData.isPracticing || isPracticing,
                        isFiveMin: existingData.isFiveMin || isFiveMin,
                        isWorkout: existingData.isWorkout || isWorkout,
                        isStretch: existingData.isStretch || isStretch,
                        practiceCount: (existingData.practiceCount || 0) + (isPracticing ? 1 : 0),
                        fiveMinCount: (existingData.fiveMinCount || 0) + (isFiveMin ? 1 : 0),
                        workoutMins: (existingData.workoutMins || 0) + addedWorkoutMins,
                        stretchMins: (existingData.stretchMins || 0) + addedStretchMins,
                        timestamp: serverTimestamp()
                    };

                    await setDoc(logRef, logData);
                    
                    const prevUserEntry = allUsersInfo.find(u => u.id === user.uid);
                    
                    await setDoc(userRef, {
                        displayName: user.displayName || `使用者 ${user.uid.slice(0, 5)}`,
                        photoURL: user.photoURL || null,
                        totalMins: (prevUserEntry?.totalMins || 0) + addedTotalMins,
                        practiceCount: (prevUserEntry?.practiceCount || 0) + (isPracticing ? 1 : 0),
                        fiveMinCount: (prevUserEntry?.fiveMinCount || 0) + (isFiveMin ? 1 : 0),
                        workoutMins: (prevUserEntry?.workoutMins || 0) + addedWorkoutMins,
                        stretchMins: (prevUserEntry?.stretchMins || 0) + addedStretchMins,
                        lastActive: serverTimestamp()
                    }, { merge: true });

                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: [BRAND_GREEN, NIPPON_YELLOW] });
                    setShowLogModal(false);
                    // Reset local form state
                    setIsPracticing(false); setIsFiveMin(false); setIsWorkout(false); setIsStretch(false);
                    setWorkoutMins(5); setStretchMins(5);
                } catch (err) {
                    console.error(err);
                    alert("儲存失敗：請檢查 Firebase 權限設定");
                }
            };

            const calendarDays = useMemo(() => {
                const year = selectedDate.getFullYear();
                const month = selectedDate.getMonth();
                
                if (calendarView === 'month') {
                    const firstDayOfMonth = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const days = [];
                    for (let i = 0; i < firstDayOfMonth; i++) days.push(null);
                    for (let i = 1; i <= daysInMonth; i++) days.push(i);
                    return days;
                } else {
                    const current = new Date(selectedDate);
                    const dayOfWeek = current.getDay();
                    const diff = current.getDate() - dayOfWeek;
                    const startOfWeek = new Date(current.getFullYear(), current.getMonth(), diff);
                    
                    return Array(7).fill(0).map((_, i) => {
                        const d = new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate() + i);
                        return { 
                            day: d.getDate(), 
                            month: d.getMonth() + 1,
                            fullDate: getDateKey(d) 
                        };
                    });
                }
            }, [selectedDate, calendarView]);

            const weekDaysLabels = ['日', '一', '二', '三', '四', '五', '六'];

            const getWeekOfMonth = (date) => {
                const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
                const dayOfMonth = date.getDate();
                const offset = firstDayOfMonth.getDay();
                return Math.ceil((dayOfMonth + offset) / 7);
            };

            const WeeklyProjectStatus = ({ type, label }) => (
                <div className="bg-white rounded-[1.5rem] p-5 border-2 flex flex-col w-full" style={{ borderColor: JAPAN_TEAL, boxShadow: `6px 6px 0px 0px ${JAPAN_TEAL}` }}>
                    <div className="flex flex-row justify-center items-baseline mb-2 space-x-3">
                        <span className="text-xl font-black" style={{ color: JAPAN_TEAL }}>{label}</span>
                        <div className="flex items-baseline space-x-1">
                            <span className="text-2xl font-black" style={{ color: JAPAN_TEAL }}>
                                {type === 'practice' ? weeklyStats.practiceCount : weeklyStats.fiveMinCount}
                            </span>
                            <span className="text-xs font-black opacity-60" style={{ color: JAPAN_TEAL }}>次累計/週</span>
                        </div>
                    </div>
                    <div className="flex justify-center gap-x-[3pt] items-center border-t pt-3" style={{ borderColor: `${JAPAN_TEAL}1a` }}>
                        {weekDaysLabels.map((dayName, i) => {
                            const d = new Date(); 
                            const diff = d.getDate() - d.getDay();
                            const targetDay = new Date(d.getFullYear(), d.getMonth(), diff + i);
                            const key = getDateKey(targetDay);
                            const log = dailyLogs[key];
                            const isDone = log && (type === 'practice' ? log.isPracticing : log.isFiveMin);
                            
                            return (
                                <div key={i} className="flex flex-col items-center flex-1">
                                    <StatusIndicator active={!!isDone} size={26} type="smile" />
                                    <span className="text-[10px] font-black opacity-40 mt-1">{dayName}</span>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );

            // 渲染登入介面
            if (!user && !loading && activeTab === 'profile') {
                return (
                    <div className="min-h-screen bg-[#beff64] flex flex-col items-center justify-center p-6 text-center animate-in fade-in duration-700">
                        <div className="relative mb-8">
                            <div className="w-32 h-32 bg-white rounded-full border-4 flex items-center justify-center animate-bounce shadow-[12px_12px_0px_0px_rgba(6,95,70,1)]" style={{ borderColor: JAPAN_TEAL }}>
                                <StatusIndicator size={80} active={true} type="smile" />
                            </div>
                            <Zap size={32} className="absolute -top-4 -right-4 text-emerald-900 fill-emerald-900 rotate-12" />
                        </div>
                        <h1 className="text-5xl font-black mb-2 tracking-tighter" style={{ color: JAPAN_TEAL }}>自律動起來</h1>
                        <p className="text-lg font-bold opacity-70 mb-12" style={{ color: JAPAN_TEAL }}>登入後即可同步數據，與好友一同努力</p>
                        <div className="w-full max-w-xs space-y-4">
                            <button 
                                onClick={handleGoogleLogin}
                                className="w-full bg-white border-4 p-4 rounded-3xl flex items-center justify-center space-x-3 hover:translate-y-[-4px] active:translate-y-[0px] transition-all shadow-[8px_8px_0px_0px_rgba(6,95,70,1)] font-black text-lg"
                                style={{ borderColor: JAPAN_TEAL, color: JAPAN_TEAL }}
                            >
                                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-6 h-6" alt="Google" />
                                <span>使用 Google 帳號登入</span>
                            </button>
                            <button onClick={() => setActiveTab('dashboard')} className="text-sm font-bold opacity-50 underline" style={{ color: JAPAN_TEAL }}>先隨便逛逛</button>
                        </div>
                    </div>
                );
            }

            if (loading) return <div className="min-h-screen bg-[#beff64] flex items-center justify-center font-black text-xl text-gray-800">載入中...</div>;

            return (
                <div className="min-h-screen bg-white text-gray-600 font-sans pb-32">
                    <header className="sticky top-0 z-10 bg-white/90 backdrop-blur-md px-6 py-5 flex justify-between items-center border-b-2" style={{ borderColor: JAPAN_TEAL }}>
                        <div className="flex items-center space-x-2 text-black" style={{ color: JAPAN_TEAL }}>
                            <div className="w-8 h-8 bg-[#beff64] rounded-lg border-2 flex items-center justify-center" style={{ borderColor: JAPAN_TEAL }}>
                                 <div className="w-4 h-4 rounded-sm" style={{ backgroundColor: JAPAN_TEAL }}></div>
                            </div>
                            <h1 className="text-xl font-black tracking-tight">自律動起來</h1>
                        </div>
                        <button onClick={() => setActiveTab('profile')} className="w-10 h-10 rounded-xl bg-[#beff64] border-2 flex items-center justify-center hover:translate-y-[-2px] transition-transform overflow-hidden" style={{ borderColor: JAPAN_TEAL, boxShadow: `3px 3px 0px 0px ${JAPAN_TEAL}` }}>
                             {user && user.photoURL ? <img src={user.photoURL} alt="User" className="w-full h-full object-cover" /> : <User size={20} strokeWidth={3} style={{ color: JAPAN_TEAL }} />}
                        </button>
                    </header>

                    <main className="max-w-2xl mx-auto px-6 py-4">
                        {activeTab === 'dashboard' && (
                            <div className="space-y-4 animate-in fade-in duration-500">
                                <section className="bg-white rounded-[1.5rem] p-5 border-2 flex justify-between items-center" style={{ borderColor: JAPAN_TEAL, boxShadow: `6px 6px 0px 0px ${JAPAN_TEAL}` }}>
                                    <h2 className="text-lg font-black tracking-tight" style={{ color: JAPAN_TEAL }}>本週累計自律時間</h2>
                                    <div className="flex items-baseline space-x-1">
                                        <span className="text-3xl font-black tracking-tighter text-[#33cc99]">
                                            {weeklyStats.totalMins}
                                        </span>
                                        <span className="text-xs font-black" style={{ color: JAPAN_TEAL }}>min</span>
                                    </div>
                                </section>
                                <section className="flex flex-col space-y-4">
                                    <WeeklyProjectStatus type="practice" label="練功" />
                                    <WeeklyProjectStatus type="fiveMin" label="五分鐘" />
                                </section>
                                <button onClick={() => setShowLogModal(true)} className="w-full bg-[#beff64] border-2 rounded-[1.5rem] p-5 flex items-center justify-center space-x-3 font-black hover:translate-y-[-2px] transition-all" style={{ borderColor: JAPAN_TEAL, color: JAPAN_TEAL, boxShadow: `4px 4px 0px 0px ${JAPAN_TEAL}` }}>
                                    <Plus size={24} strokeWidth={3} />
                                    <span className="text-lg">今日打卡</span>
                                </button>
                            </div>
                        )}

                        {activeTab === 'calendar' && (
                            <div className="space-y-4 animate-in fade-in duration-500">
                                <div className="flex justify-between items-center px-2">
                                    <h2 className="text-2xl font-black" style={{ color: JAPAN_TEAL }}>紀錄日曆</h2>
                                    <div className="flex items-center space-x-2">
                                        <button onClick={goToToday} className="bg-[#beff64] border-2 px-4 py-1.5 rounded-full font-black text-xs transition-all" style={{ borderColor: JAPAN_TEAL, color: JAPAN_TEAL, boxShadow: `2px 2px 0px 0px ${JAPAN_TEAL}` }}>今日</button>
                                        <div className="flex bg-gray-100 p-1 rounded-xl border-2 scale-90" style={{ borderColor: JAPAN_TEAL }}>
                                            <button onClick={() => setCalendarView('week')} className={`px-3 py-1 rounded-lg transition-all ${calendarView === 'week' ? 'bg-emerald-900 text-white' : 'opacity-50'}`} style={{ color: calendarView === 'week' ? 'white' : JAPAN_TEAL }}><Rows size={14} /></button>
                                            <button onClick={() => setCalendarView('month')} className={`px-3 py-1 rounded-lg transition-all ${calendarView === 'month' ? 'bg-emerald-900 text-white' : 'opacity-50'}`} style={{ color: calendarView === 'month' ? 'white' : JAPAN_TEAL }}><LayoutGrid size={14} /></button>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-white rounded-[2rem] p-6 border-2" style={{ borderColor: JAPAN_TEAL, boxShadow: `8px 8px 0px 0px ${JAPAN_TEAL}` }}>
                                    <div className="flex justify-between items-center mb-6 px-2" style={{ color: JAPAN_TEAL }}>
                                        <button onClick={() => changeDateRange(-1)} className="p-2 border-2 rounded-xl" style={{ borderColor: JAPAN_TEAL }}><ChevronLeft size={18} /></button>
                                        <span className="text-lg font-black">
                                            {calendarView === 'month' 
                                                ? `${selectedDate.getFullYear()}年 ${selectedDate.getMonth() + 1}月`
                                                : `${selectedDate.getFullYear()}年 ${selectedDate.getMonth() + 1}月 第${getWeekOfMonth(selectedDate)}週`
                                            }
                                        </span>
                                        <button onClick={() => changeDateRange(1)} className="p-2 border-2 rounded-xl" style={{ borderColor: JAPAN_TEAL }}><ChevronRight size={18} /></button>
                                    </div>
                                    <div className="grid grid-cols-7 text-center">
                                        {weekDaysLabels.map((d, i) => <div key={i} className="font-black text-gray-300 mb-2 text-[18pt]">{d}</div>)}
                                        
                                        {calendarView === 'month' ? calendarDays.map((day, idx) => {
                                            if (!day) return <div key={idx} className="h-12" />;
                                            const dateObj = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), day);
                                            const dateStr = getDateKey(dateObj);
                                            const isToday = dateStr === todayKey;
                                            const isSelected = dateStr === getDateKey(selectedDate);
                                            const log = dailyLogs[dateStr];
                                            const hasLog = log && (log.isPracticing || log.isFiveMin || log.isWorkout || log.isStretch);
                                            
                                            const showBorder = isToday || isSelected;

                                            return (
                                                <div key={idx} className="h-12 flex items-center justify-center relative cursor-pointer" onClick={() => setSelectedDate(dateObj)}>
                                                    <span className={`font-black text-[22pt] px-2 py-1 rounded-xl transition-all ${isToday ? 'bg-[#beff64]' : isSelected ? 'bg-gray-100/50' : (idx % 7 === 0 || idx % 7 === 6) ? 'text-[#EF4444]' : 'text-gray-600'}`} style={showBorder ? { borderColor: JAPAN_TEAL, borderWidth: '2px', color: JAPAN_TEAL } : {}}>{day}</span>
                                                    {hasLog && (
                                                        <div className="absolute inset-0 flex items-center justify-center animate-in zoom-in pointer-events-none">
                                                            <StatusIndicator size={42} active={true} type="smile" />
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        }) : calendarDays.map((data, idx) => {
                                            const log = dailyLogs[data.fullDate];
                                            const hasLog = log && (log.isPracticing || log.isFiveMin || log.isWorkout || log.isStretch);
                                            const isToday = data.fullDate === todayKey;
                                            const isSelected = data.fullDate === getDateKey(selectedDate);
                                            return (
                                                <div key={idx} className="flex flex-col items-center space-y-1 cursor-pointer" onClick={() => setSelectedDate(new Date(data.fullDate))}>
                                                    <div className={`w-14 h-14 flex items-center justify-center rounded-2xl border-2 ${isToday ? 'bg-[#beff64]' : isSelected ? 'bg-gray-100/50 border-dashed' : 'border-transparent'}`} style={{ borderColor: (isToday || isSelected) ? JAPAN_TEAL : 'transparent' }}>
                                                        {hasLog ? <StatusIndicator size={46} active={true} type="smile" /> : <div className="w-2 h-2 rounded-full bg-gray-100" />}
                                                    </div>
                                                    <span className={`text-[10px] font-black ${idx === 0 || idx === 6 ? 'text-[#EF4444]' : 'text-gray-400'}`}>
                                                        {data.month}/{data.day}
                                                    </span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'ranking' && (
                            <div className="space-y-8 animate-in fade-in duration-500 pb-10">
                                <div className="text-center space-y-2">
                                    <h2 className="text-3xl font-black" style={{ color: JAPAN_TEAL }}>自律達人</h2>
                                    <div className="text-[10px] font-black opacity-30 tracking-widest" style={{ color: JAPAN_TEAL }}>數據採週統計基準</div>
                                </div>
                                
                                <div className="flex flex-wrap justify-center gap-2 px-2">
                                    <RankingFilterBtn active={rankingType === 'totalMins'} onClick={() => setRankingType('totalMins')} label="自律" />
                                    <RankingFilterBtn active={rankingType === 'practiceCount'} onClick={() => setRankingType('practiceCount')} label="練功" />
                                    <RankingFilterBtn active={rankingType === 'fiveMinCount'} onClick={() => setRankingType('fiveMinCount')} label="五分鐘" />
                                    <RankingFilterBtn active={rankingType === 'workoutMins'} onClick={() => setRankingType('workoutMins')} label="運動" />
                                    <RankingFilterBtn active={rankingType === 'stretchMins'} onClick={() => setRankingType('stretchMins')} label="拉筋" />
                                </div>

                                <div className="flex items-end justify-center space-x-2 pt-10 px-4">
                                    {sortedRankings[1] && (
                                        <div className="flex flex-col items-center w-24">
                                            <div className="flex flex-col items-center mb-1">
                                                <span className="text-xl font-black" style={{ color: JAPAN_TEAL }}>{sortedRankings[1][rankingType] || 0}</span>
                                                <span className="text-[10px] font-bold opacity-40 -mt-1">{rankingType.includes('Count') ? '次' : 'min'}</span>
                                            </div>
                                            <div className="bg-[#beff64] w-full rounded-t-xl h-24 flex flex-col items-center justify-center p-2 border-x-2 border-t-2" style={{ borderColor: JAPAN_TEAL }}>
                                                <span className="text-[12px] font-black truncate w-full text-center" style={{ color: JAPAN_TEAL }}>{sortedRankings[1].displayName}</span>
                                            </div>
                                        </div>
                                    )}

                                    {sortedRankings[0] && (
                                        <div className="flex flex-col items-center w-28">
                                            <div className="flex flex-col items-center mb-1">
                                                <span className="text-3xl font-black" style={{ color: JAPAN_TEAL }}>{sortedRankings[0][rankingType] || 0}</span>
                                                <span className="text-xs font-bold opacity-40 -mt-1">{rankingType.includes('Count') ? '次' : 'min'}</span>
                                            </div>
                                            <div className="bg-[#beff64] w-full rounded-t-xl h-36 flex flex-col items-center justify-center p-2 border-x-2 border-t-2 shadow-sm" style={{ borderColor: JAPAN_TEAL }}>
                                                <span className="text-sm font-black truncate w-full text-center" style={{ color: JAPAN_TEAL }}>{sortedRankings[0].displayName}</span>
                                            </div>
                                        </div>
                                    )}

                                    {sortedRankings[2] && (
                                        <div className="flex flex-col items-center w-24">
                                            <div className="flex flex-col items-center mb-1">
                                                <span className="text-lg font-black" style={{ color: JAPAN_TEAL }}>{sortedRankings[2][rankingType] || 0}</span>
                                                <span className="text-[10px] font-bold opacity-40 -mt-1">{rankingType.includes('Count') ? '次' : 'min'}</span>
                                            </div>
                                            <div className="bg-[#beff64] w-full rounded-t-xl h-20 flex flex-col items-center justify-center p-2 border-x-2 border-t-2" style={{ borderColor: JAPAN_TEAL }}>
                                                <span className="text-[12px] font-black truncate w-full text-center" style={{ color: JAPAN_TEAL }}>{sortedRankings[2].displayName}</span>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="space-y-3 px-4 pt-4">
                                    {sortedRankings.map((u, i) => (
                                        <div 
                                            key={u.id} 
                                            className={`border-2 rounded-2xl p-4 flex justify-between items-center transition-all hover:translate-x-1 ${i < 3 ? 'bg-[#beff64]/5' : 'bg-white'}`} 
                                            style={{ 
                                                borderColor: JAPAN_TEAL, 
                                                boxShadow: `4px 4px 0px 0px ${JAPAN_TEAL}`
                                            }}
                                        >
                                            <div className="flex items-center space-x-4">
                                                <span className={`font-black w-6 italic ${i < 3 ? 'text-[#33cc99]' : 'text-gray-300'}`}>#{i + 1}</span>
                                                <div className="flex flex-col">
                                                    <span className="font-black" style={{ color: JAPAN_TEAL }}>{u.displayName}</span>
                                                    {u.id === user?.uid && <span className="text-[8px] font-bold bg-emerald-900 text-white px-1 rounded inline-block w-fit">本人</span>}
                                                </div>
                                            </div>
                                            <div className="flex items-baseline space-x-1">
                                                <span className="font-black text-xl text-[#33cc99]">{u[rankingType] || 0}</span>
                                                <span className="text-[10px] font-bold opacity-30">{rankingType.includes('Count') ? '次' : 'min'}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'profile' && user && (
                            <div className="flex flex-col items-center animate-in fade-in duration-500 py-6 space-y-8">
                                <div className="flex flex-col items-center space-y-4">
                                    <div className="w-24 h-24 rounded-3xl bg-[#beff64] border-2 flex items-center justify-center shadow-[8px_8px_0px_0px_rgba(6,95,70,1)] overflow-hidden" style={{ borderColor: JAPAN_TEAL }}>
                                        {user.photoURL ? <img src={user.photoURL} alt="User" className="w-full h-full object-cover" /> : <StatusIndicator size={56} active={true} color={BRAND_GREEN} type="smile" />}
                                    </div>
                                    <div className="text-center space-y-1">
                                        <h2 className="text-2xl font-black" style={{ color: JAPAN_TEAL }}>{user.displayName || `使用者 ${user.uid.slice(0, 5)}`}</h2>
                                        <div className="bg-[#beff64] border-2 px-3 py-1 rounded-full text-xs font-black inline-block mt-1" style={{ borderColor: JAPAN_TEAL, color: JAPAN_TEAL }}>
                                            本月統計
                                        </div>
                                    </div>
                                </div>

                                <div className="w-full max-sm px-2">
                                    <div className="w-full mb-4">
                                        <ProfileStatCard 
                                            icon={<BarChart3 className="text-emerald-600" size={28} />} 
                                            label="總自律" 
                                            value={monthlyStats.totalMins} 
                                            unit="min" 
                                            highlight={true}
                                        />
                                    </div>

                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                        <ProfileStatCard 
                                            icon={<Flame className="text-orange-500" size={24} />} 
                                            label="練功" 
                                            value={monthlyStats.practiceCount} 
                                            unit="次" 
                                        />
                                        <ProfileStatCard 
                                            icon={<Clock className="text-blue-500" size={24} />} 
                                            label="五分鐘" 
                                            value={monthlyStats.fiveMinCount} 
                                            unit="次" 
                                        />
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <ProfileStatCard 
                                            icon={<Dumbbell className="text-indigo-600" size={24} />} 
                                            label="總運動" 
                                            value={monthlyStats.workoutMins} 
                                            unit="min" 
                                        />
                                        <ProfileStatCard 
                                            icon={<Smile className="text-amber-500" size={24} />} 
                                            label="總拉筋" 
                                            value={monthlyStats.stretchMins} 
                                            unit="min" 
                                        />
                                    </div>
                                </div>

                                <button onClick={handleLogout} className="mt-8 flex items-center space-x-2 text-red-500 font-bold opacity-60 hover:opacity-100">
                                    <LogOut size={16} />
                                    <span>登出帳號</span>
                                </button>
                            </div>
                        )}
                    </main>

                    {/* 打卡 Modal 視窗 */}
                    {showLogModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-emerald-900/50 backdrop-blur-sm" onClick={() => setShowLogModal(false)}></div>
                            <div className="bg-white w-full max-w-sm rounded-[2rem] p-6 relative animate-in zoom-in duration-300 border-4" style={{ borderColor: JAPAN_TEAL }}>
                                <button onClick={() => setShowLogModal(false)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                                    <XCircle size={28} />
                                </button>
                                
                                <h2 className="text-2xl font-black mb-6 text-center" style={{ color: JAPAN_TEAL }}>今日成果打卡</h2>
                                
                                <div className="space-y-4">
                                    {/* 1. 練功 */}
                                    <div 
                                        onClick={() => setIsPracticing(!isPracticing)}
                                        className={`p-4 rounded-2xl border-2 flex items-center justify-between cursor-pointer transition-all ${isPracticing ? 'bg-[#beff64]' : 'bg-gray-50'}`}
                                        style={{ borderColor: isPracticing ? JAPAN_TEAL : 'transparent' }}
                                    >
                                        <div className="flex items-center space-x-3">
                                            <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${isPracticing ? 'bg-emerald-700 border-emerald-700' : 'border-gray-300'}`}>
                                                {isPracticing && <Check size={14} color="white" strokeWidth={4} />}
                                            </div>
                                            <span className="font-black text-lg text-gray-700">完成練功</span>
                                        </div>
                                        <Flame className={isPracticing ? 'text-orange-600' : 'text-gray-300'} />
                                    </div>

                                    {/* 2. 五分鐘 */}
                                    <div 
                                        onClick={() => setIsFiveMin(!isFiveMin)}
                                        className={`p-4 rounded-2xl border-2 flex items-center justify-between cursor-pointer transition-all ${isFiveMin ? 'bg-[#beff64]' : 'bg-gray-50'}`}
                                        style={{ borderColor: isFiveMin ? JAPAN_TEAL : 'transparent' }}
                                    >
                                        <div className="flex items-center space-x-3">
                                            <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${isFiveMin ? 'bg-emerald-700 border-emerald-700' : 'border-gray-300'}`}>
                                                {isFiveMin && <Check size={14} color="white" strokeWidth={4} />}
                                            </div>
                                            <span className="font-black text-lg text-gray-700">五分鐘任務</span>
                                        </div>
                                        <Clock className={isFiveMin ? 'text-blue-600' : 'text-gray-300'} />
                                    </div>

                                    {/* 3. 運動時間 */}
                                    <div className={`p-4 rounded-2xl border-2 transition-all ${isWorkout ? 'bg-white border-emerald-700' : 'bg-gray-50 border-transparent'}`}>
                                        <div className="flex items-center justify-between mb-2 cursor-pointer" onClick={() => setIsWorkout(!isWorkout)}>
                                            <div className="flex items-center space-x-3">
                                                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${isWorkout ? 'bg-emerald-700 border-emerald-700' : 'border-gray-300'}`}>
                                                     {isWorkout && <Check size={14} color="white" strokeWidth={4} />}
                                                </div>
                                                <span className="font-black text-lg text-gray-700">運動</span>
                                            </div>
                                            <Dumbbell className={isWorkout ? 'text-indigo-600' : 'text-gray-300'} />
                                        </div>
                                        {isWorkout && (
                                            <div className="mt-3 pl-9">
                                                <select 
                                                    value={workoutMins} 
                                                    onChange={(e) => setWorkoutMins(e.target.value)}
                                                    className="w-full p-2 rounded-lg border-2 font-bold text-center bg-gray-50 outline-none focus:border-emerald-500"
                                                >
                                                    {[5,10,15,20,30,45,60,90,120].map(m => (
                                                        <option key={m} value={m}>{m} 分鐘</option>
                                                    ))}
                                                </select>
                                            </div>
                                        )}
                                    </div>

                                    {/* 4. 拉筋時間 */}
                                    <div className={`p-4 rounded-2xl border-2 transition-all ${isStretch ? 'bg-white border-emerald-700' : 'bg-gray-50 border-transparent'}`}>
                                        <div className="flex items-center justify-between mb-2 cursor-pointer" onClick={() => setIsStretch(!isStretch)}>
                                            <div className="flex items-center space-x-3">
                                                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${isStretch ? 'bg-emerald-700 border-emerald-700' : 'border-gray-300'}`}>
                                                     {isStretch && <Check size={14} color="white" strokeWidth={4} />}
                                                </div>
                                                <span className="font-black text-lg text-gray-700">拉筋</span>
                                            </div>
                                            <Smile className={isStretch ? 'text-amber-500' : 'text-gray-300'} />
                                        </div>
                                        {isStretch && (
                                            <div className="mt-3 pl-9">
                                                <select 
                                                    value={stretchMins} 
                                                    onChange={(e) => setStretchMins(e.target.value)}
                                                    className="w-full p-2 rounded-lg border-2 font-bold text-center bg-gray-50 outline-none focus:border-emerald-500"
                                                >
                                                    {[5,10,15,20,30,45,60].map(m => (
                                                        <option key={m} value={m}>{m} 分鐘</option>
