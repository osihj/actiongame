<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>打卡排行榜</title>
<style>
  body { font-family: Arial, sans-serif; margin:20px; }
  button { margin:5px; padding:10px 15px; }
  #ranking { margin-top:20px; }
</style>
</head>
<body>

<h1>每日打卡排行榜</h1>
<div id="auth">
  <button id="loginBtn">Google 登入</button>
  <button id="logoutBtn" style="display:none;">登出</button>
</div>

<div id="userArea" style="display:none;">
  <h3 id="welcome"></h3>
  <div>
    <button data-type="practice">Practice +1</button>
    <button data-type="fiveMin">5分鐘 +1</button>
    <button data-type="workout">Workout +1</button>
    <button data-type="stretch">Stretch +1</button>
  </div>
  <h3>排行榜 (前10名)</h3>
  <ol id="ranking"></ol>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

// Firebase 配置
const firebaseConfig = {
  apiKey: "AIzaSyD9KAWLvPjTOIoImxobugT6dQUbQmJiCGg",
  authDomain: "actiongame-7c8c9.firebaseapp.com",
  projectId: "actiongame-7c8c9",
  storageBucket: "actiongame-7c8c9.firebasestorage.app",
  messagingSenderId: "386021872588",
  appId: "1:386021872588:web:eb6019fa0a182d3aec4369",
  measurementId: "G-W6CNY1D4RL"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth();
const db = getFirestore();
const provider = new GoogleAuthProvider();

// 元件
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const userArea = document.getElementById('userArea');
const welcome = document.getElementById('welcome');
const rankingEl = document.getElementById('ranking');
const buttons = document.querySelectorAll('#userArea button[data-type]');

loginBtn.addEventListener('click', async () => {
  await signInWithPopup(auth, provider);
});

logoutBtn.addEventListener('click', async () => {
  await signOut(auth);
});

onAuthStateChanged(auth, user => {
  if(user){
    loginBtn.style.display = 'none';
    logoutBtn.style.display = 'inline-block';
    userArea.style.display = 'block';
    welcome.textContent = `歡迎, ${user.displayName}`;
    updateRanking();
  } else {
    loginBtn.style.display = 'inline-block';
    logoutBtn.style.display = 'none';
    userArea.style.display = 'none';
  }
});

// 打卡功能
buttons.forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const type = btn.dataset.type;
    const user = auth.currentUser;
    if(!user) return alert("請先登入");
    await logActivity(user, type);
    updateRanking();
  });
});

async function logActivity(user, type){
  const dateKey = new Date().toISOString().slice(0,10);
  const logRef = doc(db, "users", user.uid, "logs", dateKey);
  const userRef = doc(db, "users", user.uid);

  const logSnap = await getDoc(logRef);
  const logData = logSnap.exists() ? logSnap.data() : { practice:0, fiveMin:0, workout:0, stretch:0 };
  logData[type] = (logData[type] || 0) + 1;
  await setDoc(logRef, logData, { merge:true });

  const userSnap = await getDoc(userRef);
  const prevData = userSnap.exists() ? userSnap.data() : { total:0, name: user.displayName };
  prevData.total = (prevData.total || 0) + 1;
  prevData.name = user.displayName;
  await setDoc(userRef, prevData, { merge:true });
}

// 排行榜
async function updateRanking(){
  rankingEl.innerHTML = "";
  const q = query(collection(db, "users"), orderBy("total", "desc"), limit(10));
  const snapshot = await getDocs(q);
  snapshot.forEach(doc=>{
    const data = doc.data();
    const li = document.createElement('li');
    li.textContent = `${data.name}: ${data.total}`;
    rankingEl.appendChild(li);
  });
}
</script>

</body>
</html>
